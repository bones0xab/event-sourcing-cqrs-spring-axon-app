services:
  axonserver:
    image: 'axoniq/axonserver:latest'
    environment:
      - 'AXONIQ_AXONSERVER_STANDALONE=TRUE'
    ports:
      - '8024:8024'
      - '8124:8124'
  postgres:
    image: 'postgres:latest'
    environment:
      - 'POSTGRES_DB=accounts_db'
      - 'POSTGRES_USER=admin'
      - 'POSTGRES_PASSWORD=1234'
    volumes:
      - accounts_data_fixed:/var/lib/postgresql
    ports:
      - '5433:5432'
    networks:
      - accounts-net
  pgadmin4:
    image: dpage/pgadmin4
    restart: always
    ports:
      - "8088:80"
    environment:
      PGADMIN_DEFAULT_EMAIL: med@gmail.com
      PGADMIN_DEFAULT_PASSWORD: azer
    volumes:
      - accounts_pgadmin_data:/var/lib/pgadmin
    networks:
      - accounts-net
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama # <--- Le bon chemin interne est /root/.ollama
    networks:
      - accounts-net
    restart: unless-stopped

    # Ce petit service sert juste Ã  tÃ©lÃ©charger le modÃ¨le au dÃ©marrage
  ollama-init:
    image: curlimages/curl
    container_name: ollama-init
    depends_on:
      - ollama
    networks:
      - accounts-net
    restart: on-failure
    entrypoint:
      - /bin/sh
      - -c
      - |
        echo "ðŸ” VÃ©rification du serveur Ollama..."
        # Boucle tant que le serveur ne rÃ©pond pas (Code 200)
        until curl -s -f -o /dev/null http://ollama:11434/; do
          echo "zzz... En attente de Ollama..."
          sleep 2
        done
        
        echo "âœ… Serveur en ligne ! Lancement du tÃ©lÃ©chargement..."
        # Lance le tÃ©lÃ©chargement (Ollama est intelligent : si le modÃ¨le est lÃ , il ne retÃ©lÃ©charge pas tout)
        curl -X POST http://ollama:11434/api/pull -d '{"name": "llama3.2", "stream": false}'
        
        echo "ðŸš€ TerminÃ© !"

volumes:
  accounts_data_fixed:
  accounts_pgadmin_data:
  ollama_data:

networks:
  accounts-net:
    driver: bridge